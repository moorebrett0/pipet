#!/usr/bin/env bash
set -euo pipefail

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# PiPet setup â€” creates your .env file
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

info()  { printf "\033[1;34mâ†’\033[0m %s\n" "$*"; }
ok()    { printf "\033[1;32mâœ“\033[0m %s\n" "$*"; }
warn()  { printf "\033[1;33m!\033[0m %s\n" "$*"; }
ask()   { printf "\033[1;33m?\033[0m %s " "$1"; read -r "$2"; }

echo
echo "  ðŸ™ PiPet setup"
echo "  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
echo

# â”€â”€ Step 1: Discord bot â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

info "Step 1: Create your Discord bot"
echo
echo "  1. Go to https://discord.com/developers/applications"
echo "  2. Click 'New Application' â†’ name it after your pet (e.g. 'Inky')"
echo "  3. Go to the 'Bot' tab on the left sidebar"
echo "  4. Click 'Reset Token' â†’ copy the token"
echo
ask "Paste your bot token:" BOT_TOKEN

if [ -z "$BOT_TOKEN" ]; then
    warn "no token provided, exiting"
    exit 1
fi

# â”€â”€ Step 2: Bot settings â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

echo
info "Step 2: Enable Message Content Intent"
echo
echo "  Still on the 'Bot' tab in the developer portal:"
echo "  â†’ Scroll down to 'Privileged Gateway Intents'"
echo "  â†’ Toggle ON 'Message Content Intent'"
echo "  â†’ Click 'Save Changes'"
echo
read -rp "  Press enter when done..."

# â”€â”€ Step 3: Invite bot â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

echo
info "Step 3: Invite the bot to your server"
echo
echo "  Go to 'OAuth2 â†’ URL Generator' in the developer portal:"
echo "  â†’ Scopes: check 'bot' and 'applications.commands'"
echo "  â†’ Bot Permissions: check these:"
echo "      âœ“ Send Messages"
echo "      âœ“ Send Messages in Threads"
echo "      âœ“ Create Public Threads"
echo "      âœ“ Embed Links"
echo "      âœ“ Read Message History"
echo "      âœ“ Use Slash Commands"
echo
echo "  Or paste this permissions integer: 326417525824"
echo
echo "  Copy the generated URL â†’ open it â†’ pick your server â†’ authorize."
echo
read -rp "  Press enter when done..."

# â”€â”€ Step 4: Enable Developer Mode â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

echo
info "Step 4: Get your IDs"
echo
echo "  Enable Developer Mode in Discord:"
echo "  â†’ User Settings â†’ Advanced â†’ Developer Mode â†’ ON"
echo

ask "Right-click the CHANNEL where the pet should live â†’ Copy Channel ID:" CHANNEL_ID

if [ -z "$CHANNEL_ID" ]; then
    warn "no channel ID provided, exiting"
    exit 1
fi

ask "Right-click YOURSELF â†’ Copy User ID:" OWNER_ID

if [ -z "$OWNER_ID" ]; then
    warn "no owner ID provided, exiting"
    exit 1
fi

# â”€â”€ Step 5: AI API key (optional) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

echo
info "Step 5: AI provider (optional)"
echo
echo "  This enables AI-powered responses."
echo "  Without a key, your pet uses template responses only."
echo
echo "  Option A: Anthropic Claude (paid)"
echo "    Get a key at: https://console.anthropic.com/settings/keys"
echo
ask "Paste your Anthropic API key (or press enter to skip):" CLAUDE_KEY

GEMINI_KEY=""
if [ -z "$CLAUDE_KEY" ]; then
    echo
    echo "  Option B: Google Gemini (free tier available)"
    echo "    Get a key at: https://aistudio.google.com/apikey"
    echo
    ask "Paste your Google API key (or press enter to skip):" GEMINI_KEY
fi

# â”€â”€ Write .env â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

ENV_FILE="$(dirname "$0")/.env"

cat > "$ENV_FILE" <<EOF
# PiPet config â€” generated by setup.sh

# Discord
DISCORD_BOT_TOKEN=$BOT_TOKEN
DISCORD_CHANNEL_ID=$CHANNEL_ID
DISCORD_OWNER_IDS=$OWNER_ID

# AI (optional â€” set one to enable AI responses)
ANTHROPIC_API_KEY=${CLAUDE_KEY:-}
GOOGLE_API_KEY=${GEMINI_KEY:-}
EOF

chmod 600 "$ENV_FILE"

echo
ok ".env written to $ENV_FILE"

# â”€â”€ Done â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

echo
ok "setup complete!"
echo
echo "  Next steps:"
echo "    go build ./cmd/pipet && ./pipet"
echo
echo "  First run will hatch your pet in the terminal,"
echo "  then it connects to Discord."
echo
echo "  Talk to your pet with @mention:"
echo "    @YourPet how are you?"
echo
